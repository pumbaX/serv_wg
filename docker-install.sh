#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker Engine –Ω–∞ Ubuntu
# –í–µ—Ä—Å–∏—è: 2.0 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫
error_exit() {
    echo -e "${RED}[–û–®–ò–ë–ö–ê] $1${NC}" >&2
    exit 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
check_root() {
    if [[ $EUID -eq 0 ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.${NC}"
        read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Ubuntu
if ! [[ -f /etc/os-release ]]; then
    error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ Linux"
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
source /etc/os-release
if [[ "$ID" != "ubuntu" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –°–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è Ubuntu. –¢–µ–∫—É—â–∏–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤: $ID${NC}"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}=== –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker ===${NC}"
echo -e "${BLUE}========================================${NC}"
echo -e "${YELLOW}–û–°: $NAME $VERSION${NC}"
echo -e "${YELLOW}–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $(uname -m)${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
AUTO_MODE=false
for arg in "$@"; do
    case $arg in
        -y|--yes)
            AUTO_MODE=true
            ;;
        *)
            ;;
    esac
done

# 1. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö/–∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
echo -e "${YELLOW}[1/7] –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤...${NC}"
sudo apt-get remove -y docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc 2>/dev/null || true
sudo apt-get autoremove -y 2>/dev/null || true
echo -e "${GREEN}‚úì –°—Ç–∞—Ä—ã–µ –ø–∞–∫–µ—Ç—ã —É–¥–∞–ª–µ–Ω—ã${NC}"

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
echo -e "${YELLOW}[2/7] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...${NC}"
sudo apt-get update || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤"
sudo apt-get upgrade -y || echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...${NC}"
echo -e "${GREEN}‚úì –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞${NC}"

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "${YELLOW}[3/7] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
    apt-transport-https \
    software-properties-common \
    || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
echo -e "${GREEN}‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"

# 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPG-–∫–ª—é—á–∞ Docker (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
echo -e "${YELLOW}[4/7] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPG-–∫–ª—é—á–∞ Docker...${NC}"
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor --yes -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
echo -e "${GREEN}‚úì GPG-–∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω${NC}"

# 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
echo -e "${YELLOW}[5/7] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker...${NC}"
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ /etc/os-release
ARCH=$(dpkg --print-architecture)
CODENAME=${VERSION_CODENAME}
if [[ -z "$CODENAME" ]]; then
    # Fallback –Ω–∞ lsb_release –µ—Å–ª–∏ VERSION_CODENAME –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞—Å—å
    CODENAME=$(lsb_release -cs)
fi

echo "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $ARCH"
echo "–ö–æ–¥–æ–≤–æ–µ –∏–º—è: $CODENAME"

echo "deb [arch=$ARCH signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $CODENAME stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
echo -e "${GREEN}‚úì –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω${NC}"

# –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤
echo -e "${YELLOW}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤...${NC}"
sudo apt-get update || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º Docker"

# 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
echo -e "${YELLOW}[6/7] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker...${NC}"
sudo apt-get install -y \
    docker-ce \
    docker-ce-cli \
    containerd.io \
    docker-buildx-plugin \
    docker-compose-plugin \
    || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker"
echo -e "${GREEN}‚úì Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"

# 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–±—ã Docker
echo -e "${YELLOW}[7/7] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–±—ã Docker...${NC}"
sudo systemctl enable docker || echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É docker${NC}"
sudo systemctl start docker || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É Docker"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Docker –∑–∞–ø—É—â–µ–Ω
if sudo systemctl is-active --quiet docker; then
    echo -e "${GREEN}‚úì Docker —Å–ª—É–∂–±–∞ –∑–∞–ø—É—â–µ–Ω–∞${NC}"
else
    error_exit "Docker —Å–ª—É–∂–±–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
echo -e "${YELLOW}–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...${NC}"
DOCKER_VERSION=$(sudo docker --version 2>/dev/null)
if [[ -n "$DOCKER_VERSION" ]]; then
    echo -e "${GREEN}‚úì $DOCKER_VERSION${NC}"
else
    error_exit "Docker CLI –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ hello-world
echo -e "${YELLOW}–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Docker...${NC}"
if timeout 30 sudo docker run --rm hello-world > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì Docker —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ—Ç —Å–µ—Ç–∏)${NC}"
    echo -e "${YELLOW}   Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è${NC}"
fi

echo -e "${BLUE}=================================${NC}"
echo -e "${GREEN}‚úÖ Docker —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!${NC}"
echo -e "${BLUE}=================================${NC}"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
ADD_TO_GROUP=true
if [[ "$AUTO_MODE" = false ]]; then
    echo -e "${YELLOW}–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ($USER) –≤ –≥—Ä—É–ø–ø—É docker?${NC}"
    echo -e "–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å docker –±–µ–∑ sudo (y/n, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é y): "
    read -r response
    if [[ ! "$response" =~ ^([nN][oO]|[nN])$ ]]; then
        ADD_TO_GROUP=true
    else
        ADD_TO_GROUP=false
    fi
fi

if [[ "$ADD_TO_GROUP" = true ]]; then
    echo -e "${YELLOW}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $USER –≤ –≥—Ä—É–ø–ø—É docker...${NC}"
    sudo groupadd -f docker
    sudo usermod -aG docker $USER
    echo -e "${GREEN}‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $USER –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É docker${NC}"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:${NC}"
    echo -e "   1. –í—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏ –∑–∞–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ"
    echo -e "   2. –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É: ${BLUE}newgrp docker${NC}"
    echo -e "   3. –ò–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª/—Å–µ—Å—Å–∏—é"
    echo ""
fi

echo ""
echo -e "${GREEN}–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
echo ""
echo -e "${BLUE}‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨${NC}"
echo -e "${GREEN}üì¶ –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Docker:${NC}"
echo -e "${BLUE}‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨${NC}"
echo -e "  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é:        ${GREEN}docker --version${NC}"
echo -e "  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:        ${GREEN}sudo systemctl status docker${NC}"
echo -e "  –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${GREEN}docker run hello-world${NC}"
echo -e "  –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—Ä–∞–∑—ã:         ${GREEN}docker images${NC}"
echo -e "  –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:     ${GREEN}docker ps -a${NC}"
echo -e "  –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:     ${GREEN}docker info${NC}"
echo -e "${BLUE}‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨${NC}"
echo ""
echo -e "${YELLOW}üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:${NC}"
echo -e "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è docker –±–µ–∑ sudo –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å–µ—Å—Å–∏–∏"
echo "–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É: ${BLUE}newgrp docker${NC}"
echo ""
